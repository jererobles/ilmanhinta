# Lightweight OpenTelemetry Collector Configuration
# This config receives OTLP telemetry from applications and scrapes Prometheus metrics,
# then exposes everything in Prometheus format for local Prometheus to scrape.

receivers:
  # Receive OTLP telemetry from application services (API, Dagster)
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Scrape Prometheus-format metrics from sql-exporter and API
  prometheus:
    config:
      scrape_configs:
        - job_name: 'otel-collector'
          scrape_interval: 15s
          static_configs:
            - targets: ['localhost:8888']

        - job_name: 'postgres'
          scrape_interval: 15s
          static_configs:
            - targets: ['sql-exporter:9399']

        - job_name: 'ilmanhinta-api'
          scrape_interval: 15s
          static_configs:
            - targets: ['api:8000']

processors:
  # Batch telemetry for efficiency
  batch:
    send_batch_size: 1000
    timeout: 10s

  # Prevent memory issues
  memory_limiter:
    check_interval: 1s
    limit_mib: 200
    spike_limit_mib: 50

exporters:
  # Expose metrics in Prometheus format on :8889/metrics
  # Prometheus will scrape this endpoint
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: ilmanhinta

  # Log traces to console (useful for debugging)
  # In production, you'd configure otlp exporter to send to external SigNoz
  logging:
    loglevel: info
    sampling_initial: 5
    sampling_thereafter: 200

  # Optional: Forward to external SigNoz if OTEL_EXPORTER_OTLP_ENDPOINT is set
  # Uncomment and configure when using external observability backend
  # otlp:
  #   endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT}
  #   tls:
  #     insecure: true

service:
  telemetry:
    metrics:
      address: ":8888"  # Internal metrics for collector health

  pipelines:
    # Metrics pipeline: receive from OTLP and Prometheus scraping, export to Prometheus
    metrics:
      receivers: [otlp, prometheus]
      processors: [memory_limiter, batch]
      exporters: [prometheus]

    # Traces pipeline: receive from OTLP, log to console
    # To send to external SigNoz, add 'otlp' to exporters list
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch]
      exporters: [logging]

    # Logs pipeline: receive from OTLP, log to console
    # To send to external SigNoz, add 'otlp' to exporters list
    logs:
      receivers: [otlp]
      processors: [memory_limiter, batch]
      exporters: [logging]
